<!DOCTYPE html>
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
    <title>Avplayer Chat</title>
<link href="css/chatstyle.css" type="text/css" rel="stylesheet" />
    <script src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.9.1.min.js"></script>
    <script type="text/javascript">
	var theSearchURL = "https://avlog.avplayer.org/rpc/search?channel=3597082&q=&date=";
	var theMessageURL = "https://avlog.avplayer.org/rpc/message";
	//var theSearchURL = "data.json";
	//var theMessageURL = "message.json";
    var arrList = [{
            "date": getdatetime(),
            "channel": "3597082",
            "nick": "管理员",
            "message": "欢迎进入Avplayer群聊天室",
            "id": "0"
        }];
     var mutex = false;
        function getdatetime()
		{
			var now = new Date();
			var Y=now.getFullYear();
			var M="0"+(now.getMonth()+1);
			var D="0"+now.getDate();
			var h="0"+now.getHours();
			var m="0"+now.getMinutes();
			var s="0"+now.getSeconds();
			if(M>9){M=now.getMonth()+1}
			if(D>9){D=now.getDate()}
			if(h>9){h=now.getHours()}
			if(m>9){m=now.getMinutes()}
			if(s>9){s=now.getSeconds()}
			return (Y+"-"+M+"-"+D+" "+h+":"+m+":"+s);
		}
        $(document).ready(function () {
            initusername();
            appendmessage2(arrList[0]);	//append welcome message
            getoldmessagefromajax();
            setTimeout(getmessagebymutex, 30000);
            getnewmessagefromajax();
            $("#DataToSend").keydown(function(event){
			if(event.keyCode == 13)
				postmessagetoajax();
		})
        });
        function initusername()
        {
        	var x = 1000;
        	var y = 9999;
        	var rand = parseInt(Math.random() * (x - y + 1) + y);
        	$("#txtName").val("访客"+rand);
        }
        function getoldmessagefromajax()
        {
            $.getJSON(theSearchURL, function(data1){
						var lastID = parseInt(arrList[arrList.length-1].id);
						var num = 0;
						for(num = data1.data.length - 1;
							num >= 0; num -- )
						{
							if((parseInt(data1.data[num].id)) <= lastID)
								continue;
							appendmessage2(data1.data[num]);
							arrList.push(data1.data[num]);
						}
						getmessagebymutex();
						flashtitleandscrollbottom();
                    });
        }
        function appendmessage(message)
        {
        	var string = "<span onmouseout='this.style.backgroundColor=\"\"' onmouseover='this.style.backgroundColor=\"#CCFFFF\"'><span class='datetime'>" + message.date/*.substring(11, message.date.length)*/ + " </span>"
        	+ "<span class='nick'>" + message.nick + ": </span>" 
        	+ "<span class='message'>" + message.message + "</span><span><br />";
        	$("#Container").append(string);
        }
        function appendmessage2(message)
        {
        	var string = "<div class='chat-item'><div class='chat-item-cont'><div class='bubble-name male'>" + message.date + "&nbsp;" + message.nick + ":</div><div class='bubble-pannel'><div class='bubble-body'><div class='bubble-cont'><pre>"+ message.message +"</pre></div></div></div></div></div>";
        	$("#Container").append(string);
        }
        function flashtitleandscrollbottom()
        {
        	$('#Container').animate({scrollTop: $('#Container')[0].scrollHeight});
        	//window.focus();
        }
        function getnewmessagefromajax()
        {
        	mutex = true;
        	var msg = new Object();
             $.ajax({
				url: theMessageURL,
				dataType: "json",
				timeout: 30000,
				type: "GET",
				success: function (data1, textStatus) {
					try{
		            msg.date = getdatetime();
		            msg.channel = data1.channel;
		            msg.nick = data1.who.nick;
		            msg.message = data1.message.text;
		            msg.id = "0";
		            }
		         catch(err){
		            msg.date = getdatetime();
		            msg.channel = "3597082";
		            msg.nick = "avbot";
		            msg.message = data1.message.text;
		            msg.id = "0";
		           }
		           var lastMsg = arrList[arrList.length-1];
		           if(!( lastMsg.channel == msg.channel 
		           && lastMsg.message == msg.message ) || 
		           ((msg.channel != "3597082") && (msg.channel != 3597082) && msg.channel != ""))
		           {
			            appendmessage2(msg);
			            arrList.push(msg);
			            flashtitleandscrollbottom();
		            }
				},
				complete: function (XHRequest, T) {
				 	XHRequest= null;
				 	mutex = false;
				 	getmessagebymutex();
				 	return;
				 },
				 error: function (jqXHR, textStatus, errorThrown ) {
				 	//alert("get message error.");
				 	mutex = false;
				 }
				 });
        }
        function postmessagetoajax()
        {
        	var nickname = $("#txtName").val();
        	var inputtext = $("#DataToSend").val();
        	var msgtext = nickname + " 说 :" + inputtext;
        $.post(theMessageURL,
        "{ \"protocol\":\"rpc\",\"channel\":\"3597082\",\"message\":{\"text\" : \"" + msgtext + "\"} }" ,
    	 	function(data,status){
		    ;
		  },"json");
		  showmysendmessage();
		  	$("#DataToSend").val("");
		}
		function showmysendmessage()
		{
			var nickname = $("#txtName").val();
        	var inputtext = $("#DataToSend").val();
        	var msg = new Object();
	        msg.date = getdatetime();
	        msg.channel = "3597082";		//avplayer only
	        msg.nick = nickname;
	        msg.message = inputtext;
	        msg.id = "0";
	        appendmessage2(msg);
	        arrList.push(msg);
	        flashtitleandscrollbottom();
		}
		function getmessagebymutex()
		{
			if(!mutex)
			{
				getnewmessagefromajax();
			}
		}
    </script>
</head>
<body>
    <div id="skm_LockPane" class="LockOff"></div>
    <form id="form1" runat="server">
        <h1 class="chatName"> Avplayer Online Chat </h1>
        <br />
        <span class="chatName">用户名：</span><input type="text" id="txtName" value="访客1234" style="height:30px;" class="chatInput" autocomplete="off"/>
        <br />
        <br />
        <div id='Container' class='container'></div>
        <div id='SendDataContainer'>
        <input type="text" id="DataToSend" size="88" style="width:90%;height:25px;" autocomplete="off" class="chatInput"/>
        <!--<button id='SendData' type="button" style="width:8%;height:30px;" onclick='postmessagetoajax()'>发 送</button>-->
        <input type="button" class="orange" id='SendData' style="width:8%;height:35px;color:#ffffff;float:right;font-size:14px;" value="发  送" onclick="postmessagetoajax()">
        </div>
        <br />
    </form>
</body>
</html>


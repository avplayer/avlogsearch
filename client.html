<html>
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
    <title>Avplayer Chat</title>
 <style type="text/css">
     .container
     {
         font-family: "Courier New";
         width: 100%;
         height: 400px;
         overflow: auto;
         border: 1px solid black;
     }
     .datetime
     {
     	color: #008000;
     	font-size: 12px;
     }
     .nick
     {
     	color: #1848B5;
     	font-size: 14px;
     }
     .message
     {
   		color: #111111;
     	font-size: 14px;
     }
   </style> 

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script type="text/javascript">
	var theSearchURL = "https://avlog.avplayer.org/rpc/search?channel=3597082&q=&date=";
	var theMessageURL = "https://avlog.avplayer.org/rpc/message";
	//var theSearchURL = "data.json";
	//var theMessageURL = "message.json";
    var arrList = [{
            "date": getdatetime(),
            "channel": "3597082",
            "nick": "管理员",
            "message": "欢迎进入Avplayer群聊天室",
            "id": "0"
        }];
        function getdatetime()
		{
			var now = new Date();
			var Y=now.getFullYear();
			var M="0"+(now.getMonth()+1);
			var D="0"+now.getDate();
			var h="0"+now.getHours();
			var m="0"+now.getMinutes();
			var s="0"+now.getSeconds();
			if(M>9){M=now.getMonth()+1}
			if(D>9){D=now.getDate()}
			if(h>9){h=now.getHours()}
			if(m>9){m=now.getMinutes()}
			if(s>9){s=now.getSeconds()}
			return (Y+"-"+M+"-"+D+" "+h+":"+m+":"+s);
		}
        $(document).ready(function () {
            initusername();
            appendmessage(arrList[0]);	//append welcome message
            getoldmessagefromajax();
        });
        function initusername()
        {
        	var x = 1000;
        	var y = 9999;
        	var rand = parseInt(Math.random() * (x - y + 1) + y);
        	$("#txtName").val("访客"+rand);
        }
        function getoldmessagefromajax()
        {
            $.getJSON(theSearchURL, function(data1){
						var lastID = parseInt(arrList[arrList.length-1].id);
						var num = 0;
						for(num = data1.data.length - 1;
							num >= 0; num -- )
						{
							if((parseInt(data1.data[num].id)) <= lastID)
								continue;
							appendmessage(data1.data[num]);
							arrList.push(data1.data[num]);
						}
						getnewmessagefromajax();
						flashtitleandscrollbottom();
                    });
        }
        function appendmessage(message)
        {
        	var string = "<span class='datetime'>" + message.date.substring(11, message.date.length) + " </span>"
        	+ "<span class='nick'>" + message.nick + ": </span>" 
        	+ "<span class='message'>" + message.message + "</span><br />";
        	$("#Container").append(string);
        }
        function flashtitleandscrollbottom()
        {
        	$('#Container').animate({scrollTop: $('#Container')[0].scrollHeight});
        	window.focus();
        }
        function getnewmessagefromajax()
        {
        	var msg = new Object();
        	$.getJSON(theMessageURL, function(data1){
        	try{
	            msg.date = getdatetime();
	            msg.channel = data1.channel;
	            msg.nick = data1.who.nick;
	            msg.message = data1.message.text;
	            msg.id = "0";
	            }
	         catch(err){
	            msg.date = getdatetime();
	            msg.channel = "3597082";
	            msg.nick = "avbot";
	            msg.message = data1.message.text;
	            msg.id = "0";
	           }
	            if((msg.channel != "3597082") && (msg.channel != 3597082) && msg.channel != "")
	            	getnewmessagefromajax();
	            appendmessage(msg);
	            arrList.push(msg);
	            flashtitleandscrollbottom();
	            getnewmessagefromajax();
             });
        }
        function postmessagetoajax()
        {
        	var nickname = $("#txtName").val();
        	var inputtext = $("#DataToSend").val();
        	var msgtext = nickname + " 说 :" + inputtext;
        $.post(theMessageURL,
        "{ \"protocol\":\"rpc\",\"channel\":\"3597082\",\"message\":{\"text\" : \"" + msgtext + "\"} }" ,
    	 	function(data,status){
		    ;
		  },"json");
		  	$("#DataToSend").val("");
		}
		function showmysendmessage()
		{
			var nickname = $("#txtName").val();
        	var inputtext = $("#DataToSend").val();
        	var msg = new Object();
	        msg.date = getdatetime();
	        msg.channel = "3597082";		//avplayer only
	        msg.nick = nickname;
	        msg.message = inputtext;
	        msg.id = "0";
	        appendmessage(msg);
	        arrList.push(msg);
		}
        function EnterPress(e){ //传入 event 
			var e = e || window.event; 
			if(e.keyCode == 13){ 
					postmessagetoajax();
				} 
		} 
    </script>
</head>
<body>
    <div id="skm_LockPane" class="LockOff"></div>
    <form id="form1" runat="server">
        <h1> Avplayer Chat </h1>
        <br />
        用户名： <input type="text" id="txtName" value="访客1234"/>
        <br />
        <br />
        <div id='Container' class='container'></div>
        <div id='SendDataContainer'>
        <input type="text" id="DataToSend" size="88" style="width:90%;;height:25px;" onkeydown="EnterPress()" 
详细出处参考：http://www.jb51.net/article/23798.htm/>
        <button id='SendData' type="button" style="width:9%;height:25px;" onclick='postmessagetoajax()'>发 送</button>
        </div>
        <br />
    </form>
</body>
</html>

